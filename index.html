<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NYC Crash — Modern Dashboard</title>

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<!-- Google Fonts (optional) -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">

<style>
    :root{
        --bg:#0b1220;
        --card:#0f1724;
        --muted:#94a3b8;
        --accent:#2563eb;
        --accent-soft:#374151;
        --text:#e6eef8;
        --glass: rgba(255,255,255,0.03);
        --radius:12px;
    }
    html,body{
        height:100%;
        margin:0;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background: linear-gradient(180deg, #04060a 0%, #071028 60%);
        color:var(--text);
    }

    /* Layout */
    .app {
        display:grid;
        grid-template-columns: 260px 1fr;
        min-height:100vh;
        gap:20px;
    }

    /* Sidebar */
    .sidebar {
        padding:20px;
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        border-radius: var(--radius);
        border: 1px solid rgba(255,255,255,0.04);
        box-shadow: 0 8px 30px rgba(2,6,23,0.6);
    }
    .brand {
        display:flex;
        gap:12px;
        align-items:center;
        margin-bottom:18px;
    }
    .logo {
        width:44px;
        height:44px;
        border-radius:10px;
        background: linear-gradient(135deg,var(--accent), #7c3aed);
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:800;
        color:white;
        font-size:18px;
        box-shadow: 0 6px 18px rgba(37,99,235,0.18);
    }
    .brand h2{ margin:0; font-size:16px; letter-spacing:0.2px; }
    .brand p{ margin:0; font-size:12px; color:var(--muted); }

    .section-title { font-size:13px; color:var(--muted); margin:12px 0 6px; }

    .control { display:flex; flex-direction:column; gap:8px; margin-bottom:10px; }
    select, input[type="text"] {
        background:var(--card);
        color:var(--text);
        border:1px solid rgba(255,255,255,0.04);
        padding:8px 10px;
        border-radius:8px;
        outline:none;
        font-size:14px;
    }
    select[multiple] { height:110px; }

    .btn {
        margin-top:10px;
        display:inline-block;
        width:100%;
        padding:10px 14px;
        background: linear-gradient(90deg,var(--accent), #7c3aed);
        color:white;
        border-radius:999px;
        border:none;
        font-weight:600;
        cursor:pointer;
        box-shadow: 0 12px 30px rgba(37,99,235,0.14);
    }

    /* Main content */
    .main {
        padding:22px;
        display:flex;
        flex-direction:column;
        gap:16px;
    }

    /* Top header */
    .topbar {
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
    }
    .kpis {
        display:flex;
        gap:12px;
        flex-wrap:wrap;
    }
    .kpi {
        background:var(--card);
        border-radius:12px;
        padding:12px 14px;
        min-width:180px;
        border:1px solid rgba(255,255,255,0.03);
        box-shadow: 0 8px 18px rgba(2,6,23,0.5);
    }
    .kpi h3 { margin:0; font-size:20px; }
    .kpi p { margin:4px 0 0; color:var(--muted); font-size:13px; }

    /* Grid for charts */
    .grid {
        display:grid;
        grid-template-columns: repeat(2, minmax(0,1fr));
        grid-auto-rows: minmax(280px, auto);
        gap:16px;
    }

    .card {
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        border-radius:12px;
        padding:12px;
        border:1px solid rgba(255,255,255,0.04);
        box-shadow: 0 10px 28px rgba(2,6,23,0.45);
        display:flex;
        flex-direction:column;
        min-height:140px;
    }
    .card h4 { margin:0 0 8px; font-size:14px; color:var(--text); }

    /* Full width map row */
    .map-row { grid-column: 1 / -1; min-height:420px; }

    /* Responsive */
    @media (max-width:1000px){
        .app { grid-template-columns: 1fr; }
        .grid { grid-template-columns: 1fr; }
        .sidebar { order:2; }
        .main { order:1; }
    }

    /* small helpers */
    .muted { color:var(--muted); font-size:13px; }
    .hint { font-size:12px; color:var(--muted); margin-top:6px; }
    .loader { display:none; }
</style>
</head>
<body>

<div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Sidebar">
        <div class="brand">
            <div class="logo">NY</div>
            <div>
                <h2>NYC Crash</h2>
                <p>Interactive road-safety dashboard</p>
            </div>
        </div>

        <div class="section-title">Search</div>
        <div class="control">
            <input id="searchInput" type="text" placeholder='Try: "Brooklyn 2022 pedestrian"' />
            <div class="hint" id="searchHint"></div>
        </div>

        <div class="section-title">Filters</div>
        <div class="control">
            <label class="muted">Borough</label>
            <select id="boroughSelect"><option value="">All</option></select>
        </div>

        <div class="control">
            <label class="muted">Year</label>
            <select id="yearSelect"><option value="">All</option></select>
        </div>

        <div class="control">
            <label class="muted">Injury Type</label>
            <select id="injurySelect">
                <option value="all">All</option>
                <option value="injured">Injured</option>
                <option value="killed">Killed</option>
            </select>
        </div>

        <div class="control">
            <label class="muted">Vehicle Type (multi)</label>
            <select id="vehicleSelect" multiple></select>
        </div>

        <div class="control">
            <label class="muted">Contributing Factor (multi)</label>
            <select id="factorSelect" multiple></select>
        </div>

        <button id="generateBtn" class="btn">Generate Report</button>
        <div class="hint" style="margin-top:10px">Results update automatically when you press Generate. Filters are combined with the search box.</div>
    </aside>

    <!-- MAIN -->
    <main class="main">
        <div class="topbar">
            <div class="kpis" id="kpisRow">
                <div class="kpi card">
                    <h3 id="kpiCount">—</h3>
                    <p>Crashes (filtered)</p>
                </div>
                <div class="kpi card">
                    <h3 id="kpiInjured">—</h3>
                    <p>Total Injured</p>
                </div>
                <div class="kpi card">
                    <h3 id="kpiKilled">—</h3>
                    <p>Total Killed</p>
                </div>
                <div class="kpi card">
                    <h3 id="kpiBoroughTop">—</h3>
                    <p>Top Borough</p>
                </div>
            </div>

            <div style="display:flex;gap:12px;align-items:center">
                <div class="muted">View:</div>
                <select id="viewSelect" style="background:var(--card); color:var(--text); border-radius:10px; padding:6px;">
                    <option value="overview">Overview</option>
                    <option value="map">Map only</option>
                </select>
            </div>
        </div>

        <!-- GRID OF CHARTS -->
        <section class="grid" id="chartsGrid">

            <div class="card">
                <h4>Crashes by Borough</h4>
                <div id="boroughChart" style="flex:1;min-height:220px;"></div>
            </div>

            <div class="card">
                <h4>Crashes over Years</h4>
                <div id="yearChart" style="flex:1;min-height:220px;"></div>
            </div>

            <div class="card">
                <h4>Crash density (Hour × Day)</h4>
                <div id="heatmapChart" style="flex:1;min-height:220px;"></div>
            </div>

            <div class="card">
                <h4>Injury vs Fatalities</h4>
                <div id="pieChart" style="flex:1;min-height:220px;"></div>
            </div>

            <div class="card map-row">
                <h4>Crash Locations</h4>
                <div id="mapChart" style="height:420px;"></div>
            </div>

        </section>
    </main>
</div>

<!-- JS: fetch options + generate + render charts -->
<script>
/*
 Expected backend endpoints:
  - GET  /api/options          -> { boroughs:[], years:[], vehicle_types:[], factors:[] }
  - POST /api/generate         -> accepts JSON { borough, year, injury_type, vehicle_types, contrib_factors, q }
                                -> returns {
                                    count: int,
                                    borough_counts: {BOROUGH:count,...},
                                    year_counts: {YEAR:count,...},
                                    injured_total: int,
                                    killed_total: int,
                                    heatmap: { boroughs:[], years:[], counts2D: [[]] }   (optional)
                                    points: [{LATITUDE:.., LONGITUDE:.., BOROUGH:.., ...}, ...]
                                }
*/

// small helpers
function el(id){ return document.getElementById(id); }
function setText(id, txt){ el(id).textContent = txt; }

// initialize UI: load options
async function loadOptions(){
    try {
        const res = await fetch('/api/options');
        const opts = await res.json();
        populateSelect('boroughSelect', opts.boroughs, true);
        populateSelect('yearSelect', opts.years, true, true); // years numeric
        populateSelect('vehicleSelect', opts.vehicle_types, false);
        populateSelect('factorSelect', opts.factors, false);
    } catch(e){
        console.error('Failed to load options', e);
    }
}

function populateSelect(id, arr, includeAll=true, numeric=false){
    const s = el(id);
    s.innerHTML = '';
    if(includeAll){ const opt = document.createElement('option'); opt.value=''; opt.textContent='All'; s.appendChild(opt); }
    arr.forEach(item=>{
        const o = document.createElement('option');
        o.value = numeric ? item : item;
        o.textContent = item;
        s.appendChild(o);
    });
}

// gather filters
function gatherPayload(){
    const borough = el('boroughSelect').value || null;
    const yearRaw = el('yearSelect').value || null;
    const year = yearRaw ? (isNaN(yearRaw) ? yearRaw : Number(yearRaw)) : null;
    const injury_type = el('injurySelect').value || 'all';
    const vehicle_types = Array.from(el('vehicleSelect').selectedOptions).map(o=>o.value).filter(Boolean);
    const contrib_factors = Array.from(el('factorSelect').selectedOptions).map(o=>o.value).filter(Boolean);
    const q = el('searchInput').value || '';

    return { borough, year, injury_type, vehicle_types, contrib_factors, q };
}

// draw charts (Plotly)
function drawBoroughChart(data){
    const x = Object.keys(data || {});
    const y = Object.values(data || {});
    const trace = { x, y, type:'bar', marker:{color:'#60a5fa'} };
    const layout = { margin:{t:30,l:40,r:20,b:40}, template:'plotly_dark', paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)'};
    Plotly.react('boroughChart', [trace], layout, {responsive:true});
}

function drawYearChart(data){
    const x = Object.keys(data || {}).sort();
    const y = x.map(k=>data[k]);
    const trace = { x, y, type:'scatter', mode:'lines+markers', line:{shape:'spline', color:'#7c3aed'} };
    const layout = { margin:{t:30,l:40,r:20,b:40}, template:'plotly_dark' };
    Plotly.react('yearChart', [trace], layout, {responsive:true});
}

function drawPie(data){
    const labels = ['Injured','Killed'];
    const values = [data.injured_total || 0, data.killed_total || 0];
    const trace = { labels, values, type:'pie', hole:0.35 };
    const layout = { margin:{t:30}, template:'plotly_dark' };
    Plotly.react('pieChart', [trace], layout, {responsive:true});
}

function drawHeatmap(hm){
    if(!hm || !hm.counts2D){
        Plotly.purge('heatmapChart');
        el('heatmapChart').innerHTML = '<div class="muted">Heatmap not available for this dataset.</div>';
        return;
    }
    const trace = { z: hm.counts2D, x: hm.years, y: hm.boroughs, type:'heatmap', colorscale:'Viridis' };
    const layout = { margin:{t:20,l:60,r:20,b:60}, template:'plotly_dark' };
    Plotly.react('heatmapChart', [trace], layout, {responsive:true});
}

function drawMap(points){
    const lat = points.map(p => p.LATITUDE || p.latitude || p.lat).filter(Boolean);
    const lon = points.map(p => p.LONGITUDE || p.longitude || p.lon).filter(Boolean);
    const hover = points.map(p => p.BOROUGH || p.borough || '');
    const trace = {
        type:'scattermapbox',
        lat, lon,
        mode:'markers',
        marker:{size:7, color:'#f97316', opacity:0.7},
        text:hover
    };
    const layout = {
        mapbox:{ style:'open-street-map', center:{lat:40.7128, lon:-74.0060}, zoom:9 },
        margin:{t:10,b:10,l:10,r:10},
        template:'plotly_dark'
    };
    Plotly.react('mapChart', [trace], layout, {responsive:true});
}

// update KPIs
function updateKPIs(data){
    setText('kpiCount', data.count?.toLocaleString() ?? '0');
    setText('kpiInjured', (data.injured_total || 0).toLocaleString());
    setText('kpiKilled', (data.killed_total || 0).toLocaleString());
    // top borough heuristic
    const bc = data.borough_counts || {};
    const top = Object.entries(bc).sort((a,b)=>b[1]-a[1])[0];
    setText('kpiBoroughTop', top ? `${top[0]} (${top[1]})` : '-');
}

// main generate function
let lastPayload = null;
async function generateReport(auto=false){
    const payload = gatherPayload();
    lastPayload = payload;
    // show simple loading state
    setText('kpiCount','Loading...');
    try {
        const res = await fetch('/api/generate', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('server error '+res.status);
        const data = await res.json();

        // update UI
        updateKPIs(data);
        drawBoroughChart(data.borough_counts);
        drawYearChart(data.year_counts);
        drawPie(data);
        drawHeatmap(data.heatmap);
        drawMap(data.points || []);

        // show search hints if backend returns parsing hints
        if(data.hint) el('searchHint').textContent = data.hint;
        else el('searchHint').textContent = '';

    } catch(err){
        console.error('generateReport error', err);
        setText('kpiCount','Error');
        el('searchHint').textContent = 'خطأ أثناء جلب البيانات.';
    }
}

// auto-generate on button
el('generateBtn').addEventListener('click', ()=>generateReport(false));

// also auto-generate when filters change (debounce)
const debounce = (fn, ms=500) => {
    let t;
    return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
};
['boroughSelect','yearSelect','injurySelect','vehicleSelect','factorSelect'].forEach(id=>{
    el(id).addEventListener('change', debounce(()=>generateReport(true), 400));
});
el('searchInput').addEventListener('keyup', debounce(()=>generateReport(true), 600));

// view switch
el('viewSelect').addEventListener('change', ()=>{
    const v = el('viewSelect').value;
    const grid = el('chartsGrid');
    if(v==='map'){
        // hide other cards except map
        Array.from(grid.children).forEach(card=>{
            if(card.classList.contains('map-row')) { card.style.display='flex'; card.style.gridColumn='1 / -1'; }
            else card.style.display='none';
        });
    } else {
        Array.from(grid.children).forEach(card=>{ card.style.display='flex'; card.style.gridColumn='auto'; });
    }
});

// initial load
loadOptions().then(()=>generateReport(true));

</script>

</body>
</html>
